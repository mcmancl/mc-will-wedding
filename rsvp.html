<section id="rsvp">
  <h2>RSVP</h2>
  <p>We can’t wait to celebrate with you! Please enter your name below to RSVP for your party.</p>

  <div class="rsvp-container">
    <input type="text" id="guestNameInput" placeholder="Enter your name" />
    <button id="rsvpButton">RSVP</button>
    <p id="rsvpMessage"></p>
  </div>

  <style>
    .rsvp-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      max-width: 400px;
      margin: 2rem auto;
    }

    .rsvp-container input {
      width: 100%;
      padding: 0.8rem 1rem;
      font-family: 'Montserrat', sans-serif;
      font-size: 1rem;
      border: 2px solid var(--mulberry);
      border-radius: 8px;
    }

    .rsvp-container input:focus {
      border-color: var(--green);
      outline: none;
    }

    .rsvp-container button {
      padding: 0.8rem 1.2rem;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1rem;
      color: white;
      background-color: var(--mulberry);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .rsvp-container button:hover {
      background-color: var(--green);
    }

    #rsvpMessage {
      font-family: 'Montserrat', sans-serif;
      font-size: 0.95rem;
      color: var(--mulberry);
    }

    #rsvpMessage.error {
      color: red;
    }
  </style>

  <script>
    async function loadGuestList() {
      try {
        console.log('Fetching guest list…');
        const response = await fetch('data/guestlist.csv');
        if (!response.ok) {
          throw new Error('HTTP error ' + response.status);
        }
        const csvText = await response.text();
        console.log('CSV loaded:', csvText.slice(0,200), '…');
        const rows = csvText.trim().split('\n');
        if (rows.length < 2) {
          console.warn('CSV has no data rows.');
        }

        const partyMap = {};
        const guestMap = {};

        for (let i = 1; i < rows.length; i++) {
          const cols = rows[i].split(',').map(c => c.trim());
          if (cols.length < 3) {
            console.warn('Skipping invalid row (less than 3 cols):', rows[i]);
            continue;
          }
          const [partyKey, guestName, formUrl] = cols;
          guestMap[guestName.toLowerCase()] = partyKey;
          partyMap[partyKey] = formUrl;
        }

        console.log('Loaded guestMap keys:', Object.keys(guestMap).slice(0,20));
        console.log('Loaded partyMap keys:', Object.keys(partyMap));

        return { guestMap, partyMap };
      } catch (err) {
        console.error('Error loading guest list:', err);
        const messageEl = document.getElementById('rsvpMessage');
        messageEl.textContent = 'An error occurred while loading the guest list. Please try again later.';
        messageEl.classList.add('error');
        return { guestMap: {}, partyMap: {} };
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const { guestMap, partyMap } = await loadGuestList();
      const input = document.getElementById('guestNameInput');
      const button = document.getElementById('rsvpButton');
      const message = document.getElementById('rsvpMessage');

      button.addEventListener('click', () => {
        message.textContent = '';
        message.classList.remove('error');

        const name = input.value.trim().toLowerCase();
        if (!name) {
          message.textContent = 'Please enter your name.';
          message.classList.add('error');
          return;
        }

        const partyKey = guestMap[name];
        console.log('Entered name:', name, '→ partyKey:', partyKey);

        if (partyKey && partyMap[partyKey]) {
          console.log('Redirecting to:', partyMap[partyKey]);
          window.location.href = partyMap[partyKey];
        } else {
          message.textContent = 'Sorry, we could not find your name. Please check your spelling or contact us.';
          message.classList.add('error');
        }
      });

      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          button.click();
        }
      });
    });
  </script>
</section>
